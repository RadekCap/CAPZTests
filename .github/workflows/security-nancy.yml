name: Security - nancy

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 3:30 AM UTC
    - cron: '30 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  nancy:
    name: Nancy Dependency Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Install dependencies
      run: go mod download

    - name: Write Go Dependencies List
      run: go list -json -deps ./... > go.list

    - name: Run nancy dependency scanner
      id: nancy
      uses: sonatype-nexus-community/nancy-github-action@main
      with:
        nancyCommand: sleuth --loud
        continue-on-error: true

    - name: Generate Summary and Check for Failures
      id: summary
      run: |
        if [ "${{ steps.nancy.outcome }}" = "success" ]; then
          echo "âœ… No vulnerable dependencies found!" >> $GITHUB_STEP_SUMMARY
          echo "failure=false" >> $GITHUB_OUTPUT
        else
          echo "## âŒ Vulnerable dependencies detected!" >> $GITHUB_STEP_SUMMARY
          # Further summary details can be added here if nancy output can be parsed
          echo "failure=true" >> $GITHUB_OUTPUT
        fi

    - name: Upload dependency list
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nancy-dependency-list
        path: go.list
        retention-days: 30

    - name: Create or Update GitHub Issue
      if: steps.summary.outputs.failure == 'true' && github.event_name != 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const { repo: { owner, repo }, sha, ref_name } = context;
          const workflow_url = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
          
          const issue_title = `ðŸš¨ [nancy] Vulnerable dependencies detected on ${ref_name}`;
          
          let body = `# ðŸš¨ Security Alert: Vulnerable Go Dependencies (nancy)\n\n` +
            `## Overview\n\n` +
            `The **nancy** dependency scanner has detected Go dependencies with known vulnerabilities from the **Sonatype OSS Index**.\n\n` +
            `| Field | Value |\n` +
            `|---|---|
` +
            `| **Scanner** | nancy (Sonatype OSS Index) |\n` +
            `| **Status** | âŒ FAILED |\n` +
            `| **Workflow Run** | [${context.runId}](${workflow_url}) |\n` +
            `| **Branch** | 
${ref_name}
` +
            `| **Commit** | 
${sha}
` +
            `## ðŸ“‹ Vulnerability Details\n\n` +
            `Check the [workflow run logs](${workflow_url}) for specific vulnerable packages and versions.\n`;

          const issues = await github.rest.issues.listForRepo({
            owner,
            repo,
            labels: 'security,nancy',
            state: 'open',
          });

          const existing_issue = issues.data.find(issue => issue.title === issue_title);

          if (existing_issue) {
            console.log(`Found existing issue #${existing_issue.number}`);
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: existing_issue.number,
              body: `## ðŸ”„ Vulnerable Dependencies Still Present\n\n**New Detection**: [${context.runId}](${workflow_url})\n\n` + body,
            });
          } else {
            console.log('Creating new issue...');
            await github.rest.issues.create({
              owner,
              repo,
              title: issue_title,
              body: body,
              labels: ['security', 'nancy'],
            });
          }

    - name: Fail workflow
      if: steps.summary.outputs.failure == 'true'
      run: exit 1