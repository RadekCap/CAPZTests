name: Security - govulncheck

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest

    - name: Run govulncheck
      run: |
        echo "# govulncheck Security Scan Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Scanning Go code and dependencies for known vulnerabilities..." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if govulncheck ./... 2>&1 | tee govulncheck-output.txt; then
          echo "## ‚úÖ No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Go dependencies are free from known vulnerabilities." >> $GITHUB_STEP_SUMMARY
        else
          echo "## ‚ùå Vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat govulncheck-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          exit 1
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: govulncheck-results
        path: govulncheck-output.txt
        retention-days: 30

    - name: Create GitHub issue on vulnerability
      if: failure() && github.event_name != 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        WORKFLOW_NAME="govulncheck Security Scan"
        EXISTING_ISSUE=$(gh issue list --state open --label "security" --label "govulncheck" --search "[$WORKFLOW_NAME]" --json number,title --jq ".[0].number" 2>/dev/null || echo "")
        if [ -n "$EXISTING_ISSUE" ]; then
          echo "Existing issue found: #$EXISTING_ISSUE"
          
          SCAN_DETAILS=$(cat govulncheck-output.txt 2>/dev/null | head -100 || echo "See workflow logs for full details")
          
          BODY="## üîÑ Vulnerability Still Present\n"
          BODY="${BODY}**New Detection**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n"
          BODY="${BODY}**Date**: $(date -u +'\n%Y-%m-%d %H:%M:%S UTC')\n"
          BODY="${BODY}**Branch**: ${{ github.ref_name }}\n"
          BODY="${BODY}**Commit**: ${{ github.sha }}\n"
          BODY="${BODY}### Latest Scan Output\n"
          BODY="${BODY}<details>\n"
          BODY="${BODY}<summary>Click to expand scan results</summary>\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}$SCAN_DETAILS\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}</details>\n"
          BODY="${BODY}**Action Required**: The vulnerabilities listed in this issue are still present. Please prioritize remediation."
          
          echo -e "$BODY" > comment_body.md
          gh issue comment $EXISTING_ISSUE --body-file comment_body.md
        else
          echo "Creating new issue..."
          VULN_COUNT=$(grep -c "Vulnerability" govulncheck-output.txt 2>/dev/null || echo "unknown")
          SCAN_DETAILS=$(cat govulncheck-output.txt 2>/dev/null || echo "See workflow run logs for complete details")

          BODY="# üö® Security Alert: Go Vulnerabilities Detected\n"
          BODY="${BODY}## Overview\n"
          BODY="${BODY}The **govulncheck** security scanner has detected vulnerabilities in Go dependencies.\n"
          BODY="${BODY}| Field | Value |\n"
          BODY="${BODY}|-------|-------|\n"
          BODY="${BODY}| **Scanner** | govulncheck (Official Go vulnerability checker) |\n"
          BODY="${BODY}| **Status** | ‚ùå FAILED |\n"
          BODY="${BODY}| **Vulnerabilities** | $VULN_COUNT |\n"
          BODY="${BODY}| **Workflow Run** | [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |\n"
          BODY="${BODY}| **Branch** | ${{ github.ref_name }} |\n"
          BODY="${BODY}| **Commit** | ${{ github.sha }} |\n"
          BODY="${BODY}| **Triggered By** | ${{ github.event_name }}|\n"
          BODY="${BODY}| **Date** | $(date -u +'\n%Y-%m-%d %H:%M:%S UTC') |\n"
          BODY="${BODY}## üìã Vulnerability Details\n"
          BODY="${BODY}<details open>\n"
          BODY="${BODY}<summary><b>Scan Results (Click to collapse)</b></summary>\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}$SCAN_DETAILS\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}</details>\n"
          BODY="${BODY}## üîß Remediation Steps\n"
          BODY="${BODY}### 1Ô∏è‚É£ Review Vulnerabilities\n"
          BODY="${BODY}- Examine the scan output above\n"
          BODY="${BODY}- Check severity levels and affected packages\n"
          BODY="${BODY}- Review [Go Vulnerability Database](https://vuln.go.dev/) for details\n"
          BODY="${BODY}### 2Ô∏è‚É£ Update Dependencies\n"
          BODY="${BODY}\
```bash\n"
          BODY="${BODY}# Update specific vulnerable package\n"
          BODY="${BODY}go get -u <vulnerable-package>@<patched-version>\n"
          BODY="${BODY}# Or update all dependencies (careful - test thoroughly)\n"
          BODY="${BODY}go get -u ./...\n"
          BODY="${BODY}go mod tidy\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}### 3Ô∏è‚É£ Test Changes\n"
          BODY="${BODY}\
```bash\n"
          BODY="${BODY}# Run tests\n"
          BODY="${BODY}make test\n"
          BODY="${BODY}# Run all security scans\n"
          BODY="${BODY}make test-all\n"
          BODY="${BODY}\
```\n"
          BODY="${BODY}### 4Ô∏è‚É£ Verify Fix\n"
          BODY="${BODY}- Push changes to a branch\n"
          BODY="${BODY}- The govulncheck workflow will run automatically\n"
          BODY="${BODY}- Verify it passes before merging\n"
          BODY="${BODY}## üìö Resources\n"
          BODY="${BODY}- [Go Vulnerability Database](https://vuln.go.dev/)\n"
          BODY="${BODY}- [govulncheck Documentation](https://pkg.go.dev/golang.org/x/vuln/cmd/govulncheck)\n"
          BODY="${BODY}- [Workflow File](${{ github.server_url }}/${{ github.repository }}/blob/main/.github/workflows/security-govulncheck.yml)\n"
          BODY="${BODY}## üîî Next Steps\n"
          BODY="${BODY}1. **Assign** this issue to a developer\n"
          BODY="${BODY}2. **Prioritize** based on vulnerability severity\n"
          BODY="${BODY}3. **Update** dependencies as outlined above\n"
          BODY="${BODY}4. **Test** thoroughly to ensure no regressions\n"
          BODY="${BODY}5. **Close** this issue once the workflow passes\n"
          BODY="${BODY}---\n"
          BODY="${BODY}*ü§ñ This issue was automatically created by the [govulncheck security workflow](${{ github.server_url }}/${{ github.repository }}/actions/workflows/security-govulncheck.yml)*\n"
          
          echo -e "$BODY" > issue_body.md
          gh issue create \
            --title "üö® [govulncheck] Vulnerabilities detected on ${{ github.ref_name }}" \
            --label "security" \
            --label "govulncheck" \
            --body-file issue_body.md || \
          echo "Failed to create issue, but continuing workflow"
        fi