name: Security - govulncheck

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Install govulncheck
      run: go install golang.org/x/vuln/cmd/govulncheck@latest

    - name: Run govulncheck
      id: govulncheck
      run: |
        govulncheck ./... > govulncheck-output.txt || true

    - name: Generate Summary and Check for Failures
      id: summary
      run: |
        if ! grep -q "Vulnerability" govulncheck-output.txt;
        then
          echo "‚úÖ No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          echo "failure=false" >> $GITHUB_OUTPUT
        else
          echo "## ‚ùå Vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat govulncheck-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "failure=true" >> $GITHUB_OUTPUT
        fi

    - name: Upload scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: govulncheck-results
        path: govulncheck-output.txt
        retention-days: 30

    - name: Create or Update GitHub Issue
      if: steps.summary.outputs.failure == 'true' && github.event_name != 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const { repo: { owner, repo }, sha, ref_name } = context;
          const workflow_url = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
          
          const scan_details = fs.readFileSync('govulncheck-output.txt', 'utf8');
          const vuln_count = (scan_details.match(/Vulnerability/g) || []).length;
          
          const issue_title = `üö® [govulncheck] Vulnerabilities detected on ${ref_name}`;
          
          let body = `# üö® Security Alert: Go Vulnerabilities Detected\n\n` +
            `## Overview\n\n` +
            `The **govulncheck** security scanner has detected vulnerabilities in Go dependencies.\n\n` +
            `| Field | Value |\n` +
            `|---|---|\n` +
            `| **Scanner** | govulncheck (Official Go vulnerability checker) |\n` +
            `| **Status** | ‚ùå FAILED |\n` +
            `| **Vulnerabilities** | ${vuln_count} |\n` +
            `| **Workflow Run** | [${context.runId}](${workflow_url}) |\n` +
            `| **Branch** | 
${ref_name}
 |
` +
            `| **Commit** | 
${sha}
 |

` +
            `## üìã Vulnerability Details\n\n` +
            `<details open><summary><b>Scan Results (Click to collapse)</b></summary>\n\n` +
            