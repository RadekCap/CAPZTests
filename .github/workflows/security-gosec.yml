name: Security - gosec

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 2:30 AM UTC
    - cron: '30 2 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  gosec:
    name: Go Security Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'

    - name: Run gosec security scanner
      id: gosec
      uses: securego/gosec@master
      with:
        args: '-fmt=json -out=gosec-results.json -stdout -verbose=text ./...'
        continue-on-error: true

    - name: Generate Summary and Check for Failures
      id: summary
      run: |
        if [ ! -f gosec-results.json ] || [ $(jq '.Issues | length' gosec-results.json) -eq 0 ]; then
          echo "‚úÖ No security issues found!" >> $GITHUB_STEP_SUMMARY
          echo "failure=false" >> $GITHUB_OUTPUT
        else
          ISSUES=$(jq '.Issues | length' gosec-results.json)
          echo "## ‚ùå Security issues detected: $ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Rule | File | Line | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|---|---|---|" >> $GITHUB_STEP_SUMMARY
          jq -r '.Issues[] | "| \(.severity) | \(.rule_id) | \(.file) | \(.line) | \(.details) |"' gosec-results.json >> $GITHUB_STEP_SUMMARY
          echo "failure=true" >> $GITHUB_OUTPUT
        fi

    - name: Upload gosec results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gosec-results
        path: gosec-results.json
        retention-days: 30

    - name: Create or Update GitHub Issue
      if: steps.summary.outputs.failure == 'true' && github.event_name != 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const { repo: { owner, repo }, sha, ref_name } = context;
          const workflow_url = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
          
          const results = JSON.parse(fs.readFileSync('gosec-results.json', 'utf8'));
          const issues = results.Issues;
          
          const issue_title = `üö® [gosec] Security issues detected on ${ref_name}`;
          
          let body = `# üö® Security Alert: Code Security Issues Detected (gosec)\n\n` +
            `## Overview\n\n` +
            `The **gosec** security scanner has detected ${issues.length} issues.\n\n` +
            `| Field | Value |\n` +
            `|---|---|\n` +
            `| **Scanner** | gosec |\n` +
            `| **Status** | ‚ùå FAILED |\n` +
            `| **Total Issues** | ${issues.length} |\n` +
            `| **Workflow Run** | [${context.runId}](${workflow_url}) |\n` +
            `| **Branch** | bind{ref_name}
` +
            `| **Commit** | bind{sha}

` +
            `## üìã Security Issues Found\n\n` +
            `<details open><summary><b>Detailed Findings (Click to collapse)</b></summary>\n\n` +
            `| Severity | Rule | File | Line | Details |\n` +
            `|---|---|---|---|---|
` +
            issues.map(i => `| ${i.severity} | ${i.rule_id} | bind{i.file}
 | ${i.line} | ${i.details} |`).join('\n') +
            `\n\n</details>\n`;

          const issues_list = await github.rest.issues.listForRepo({
            owner,
            repo,
            labels: 'security,gosec',
            state: 'open',
          });

          const existing_issue = issues_list.data.find(issue => issue.title === issue_title);

          if (existing_issue) {
            console.log(`Found existing issue #${existing_issue.number}`);
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: existing_issue.number,
              body: `## üîÑ Security Issues Still Present\n\n**New Detection**: [${context.runId}](${workflow_url})\n\n` + body,
            });
          } else {
            console.log('Creating new issue...');
            await github.rest.issues.create({
              owner,
              repo,
              title: issue_title,
              body: body,
              labels: ['security', 'gosec'],
            });
          }

    - name: Fail workflow
      if: steps.summary.outputs.failure == 'true'
      run: exit 1