name: Security - Trivy

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  schedule:
    # Run daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  trivy:
    name: Trivy Security Scanner
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      id: trivy
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        exit-code: '1'
        ignore-unfixed: true
        continue-on-error: true

    - name: Run Trivy for human-readable output
      if: steps.trivy.outcome == 'failure'
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'
        output: 'trivy-results.txt'
        severity: 'CRITICAL,HIGH,MEDIUM,LOW'
        ignore-unfixed: true
        continue-on-error: true

    - name: Generate summary
      if: always()
      run: |
        if [ "${{ steps.trivy.outcome }}" != 'failure' ]; then
          echo "## ‚úÖ No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
        else
          # Fallback in case trivy-results.txt is not generated
          if [ ! -f trivy-results.txt ]; then
            echo "## ‚ùå Vulnerabilities detected!" >> $GITHUB_STEP_SUMMARY
            echo "See logs for details." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          TOTAL=$( (grep -c "Total:" trivy-results.txt || echo "Total: 0") | awk '{print $2}' )
          echo "## ‚ùå Vulnerabilities detected: $TOTAL" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload Trivy results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: trivy-results
        path: |
          trivy-results.sarif
          trivy-results.txt
        retention-days: 30

    - name: Create or Update GitHub Issue
      if: steps.trivy.outcome == 'failure' && github.event_name != 'pull_request'
      uses: actions/github-script@v6
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        script: |
          const fs = require('fs');
          const { repo: { owner, repo }, sha, ref_name } = context;
          const workflow_url = `https://github.com/${owner}/${repo}/actions/runs/${context.runId}`;
          
          let scan_details = "See workflow logs for details.";
          try {
            scan_details = fs.readFileSync('trivy-results.txt', 'utf8');
          } catch (e) {
            console.log("Could not read trivy-results.txt");
          }
          
          const issue_title = `üö® [Trivy] Vulnerabilities detected on ${ref_name}`;
          
          let body = `# üö® Security Alert: Multiple Vulnerabilities Detected (Trivy)\n\n` +
            `## Overview\n\n` +
            `The **Trivy** security scanner has detected vulnerabilities.\n\n` +
            `| Field | Value |\n` +
            `|---|---|
` +
            `| **Scanner** | Trivy |\n` +
            `| **Status** | ‚ùå FAILED |\n` +
            `| **Workflow Run** | [${context.runId}](${workflow_url}) |\n` +
            `| **Branch** | 
` + 
            `| **Commit** | 
` + 
            `## üìã Detailed Scan Results\n\n` +
            `<details open><summary><b>Trivy Findings (Click to collapse)</b></summary>\n\n` +
            